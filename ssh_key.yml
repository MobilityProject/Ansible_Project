---
- name: ssh key gen & deply
  hosts: localhost
  connection: local
  become: yes
  tasks:
  - name: include service names
    include_vars:
      file: ./Linux-server/vars/ssh_key_deploy.yml

    
  - name: Generate SSH key
    expect:
      command: ssh-keygen -t rsa -b 4096 -f /home/semaphore/.ssh/id_rsa -N ''
      responses:
        'Enter file in which to save the key': '\r'  # 기본 파일 경로를 사용하려면 그냥 Enter
        'Enter passphrase for key': '\r'              # 비밀번호 없이 생성
        'Enter same passphrase again': '\r'           # 비밀번호 확인 없이 Enter
    register: ssh_keygen_result
    ignore_errors: yes

  - name: ssh key check
    shell: cat /home/semaphore/.ssh/id_rsa
    register: private_key
    ignore_errors: yes

  - name: ssh key deploy
    shell: ssh-copy-id -i /home/semaphore/.ssh/id_rsa.pub {{ item }}
    register: result
    loop: "{{user}}"
    ignore_errors: yes

  - name: ssh key check
    debug:
      msg: >
          private_key: {{ private_key}}
          {{result}}
          "complete"
  
